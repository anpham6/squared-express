!function(){"use strict";var e;Object.defineProperty(exports,"__esModule",{value:!0});const s=require("path"),r=require("fs-extra"),t=require("yargs"),o=require("express"),i=require("cors"),n=require("body-parser"),a=require("request"),l=require("uuid"),c=require("archiver"),d=require("node-7z"),p=require("7zip-bin"),u=require("js-yaml"),g=require("chalk"),m=require("@squared-functions/file-manager"),f=p.path7za,y=o();y.use(n.urlencoded({extended:!0}));const h=m.moduleNode();let b,w,v,k,U;function S(e,s){const{chrome:r,watch:t,release:o}=s;b&&e.install("image",b),v&&e.install("gulp",v),k&&e.install("cloud",k),"1"===r&&(w&&e.install("chrome",w,"1"===o),U&&e.install("compress",U)),"1"===t&&e.install("watch",undefined)}{const a=t.usage("$0 [args]").option("access-all",{type:"boolean",description:"Grant full disk and UNC privileges"}).option("access-disk",{alias:"d",type:"boolean",description:"Grant full disk privileges"}).option("access-unc",{alias:"u",type:"boolean",description:"Grant full UNC privileges"}).option("disk-read",{alias:"r",type:"boolean",description:"Grant disk +r (read only)"}).option("disk-write",{alias:"w",type:"boolean",description:"Grant disk +w (write only)"}).option("unc-read",{alias:"y",type:"boolean",description:"Grant UNC +r (read only)"}).option("unc-write",{alias:"z",type:"boolean",description:"Grant UNC +w (write only)"}).option("env",{alias:"e",type:"string",description:"Set environment <prod|dev>",nargs:1}).option("port",{alias:"p",type:"number",description:"Set HTTP port number",nargs:1}).option("cors",{alias:"c",type:"string",description:'Enable CORS access to <origin|"*">',nargs:1}).epilogue("For more information and source: https://github.com/anpham6/squared").argv;let{NODE_ENV:l,PORT:c}=process.env,d=!1;a.accessAll?(h.setDiskRead(),h.setDiskWrite(),h.setUNCRead(),h.setUNCWrite(),d=!0):(a.accessDisk?(h.setDiskRead(),h.setDiskWrite(),d=!0):(a.diskRead&&(h.setDiskRead(),d=!0),a.diskWrite&&(h.setDiskWrite(),d=!0)),a.accessUnc?(h.setUNCRead(),h.setUNCWrite(),d=!0):(a.uncRead&&(h.setUNCRead(),d=!0),a.uncWrite&&(h.setUNCWrite(),d=!0)));let p={};try{p=r.existsSync("./squared.settings.yml")&&u.load(r.readFileSync(s.resolve("./squared.settings.yml"),"utf8"))||require("./squared.settings.json"),({compress:U,cloud:k,gulp:v,chrome:w}=p),m.loadSettings(p,d),b=require((null===(e=p.image)||void 0===e?void 0:e.command)||"@squared-functions/image/jimp")}catch(e){b=require("@squared-functions/image/jimp"),h.writeFail("Unable to load settings",e)}if(p.routing){a.env&&p.routing[a.env.trim()]?l=a.env.trim():l&&!p.routing[l]&&(l=p.env),l&&p.routing[l]||(l="development");const e=["all","get","post","put","delete","patch","options","head","checkout","connect","copy","lock","merge","mkactivity","mkcol","move","m-search","notify","propfind","proppatch","purge","report","search","subscribe","trace","unlock","unsubscribe"];let r=0,t=0;for(const i of[p.routing.__SHARED__,p.routing[l]])if(Array.isArray(i))for(const n of i){const{path:i,mount:a}=n;if(i&&a){const e=s.join(__dirname,a);try{y.use(i,o.static(e)),h.formatMessage(h.logType.SYSTEM,"MOUNT",`${g.bgGrey(e)} ${g.yellow("->")} ${g.bold(i)}`,"",{titleColor:"yellow"}),++r}catch(e){h.writeFail(["Unable to mount directory",i],e)}}else{let s=n.handler;if(s){"string"==typeof s&&(s=[s]);let r=[];for(const e of s){const s=h.parseFunction(e);s&&r.push(s)}switch(r.length){case 0:continue;case 1:r=r[0]}let o=!1;for(const s of e){const e=n[s];if(e&&"string"==typeof e){try{y[s](e,r),h.formatMessage(h.logType.SYSTEM,"ROUTE",g.bgGrey(e),"",{titleColor:"yellow"}),++t}catch(s){h.writeFail(["Unable to create route",e],s)}o=!0;break}}o||y.use(r)}}}r&&console.log(`\n${g.bold(r)} ${1===r?"directory was":"directories were"} mounted.${t?"":"\n"}`),t&&console.log(`\n${g.bold(t)} ${1===t?"route was":"routes were"} created.\n`)}else l||(l="development"),y.use("/",o.static(s.join(__dirname,"html"))),y.use("/dist",o.static(s.join(__dirname,"dist"))),h.writeFail("Routing not defined");h.formatMessage(h.logType.SYSTEM,"DISK",(h.hasDiskRead()?g.green("+"):g.red("-"))+"r "+(h.hasDiskWrite()?g.green("+"):g.red("-"))+"w","",{titleColor:"blue"}),h.formatMessage(h.logType.SYSTEM,"UNC",(h.hasUNCRead()?g.green("+"):g.red("-"))+"r "+(h.hasUNCWrite()?g.green("+"):g.red("-"))+"w","",{titleColor:"blue"}),a.cors?(y.use(i({origin:a.cors})),y.options("*",i())):p.cors&&p.cors.origin&&(y.use(i(p.cors)),y.options("*",i()),a.cors="string"==typeof p.cors.origin?p.cors.origin:"true"),h.formatMessage(h.logType.SYSTEM,"CORS",a.cors?g.green(a.cors):g.grey("disabled"),"",{titleColor:"blue"}),a.port?c=a.port.toString():!c&&p.port&&(c=p.port[l]),c=+c>=0&&c||"3000",y.use(n.json({limit:p.request_post_limit||"250mb"})),y.listen(c,(()=>{console.log(""),h.formatMessage(h.logType.SYSTEM,l.toUpperCase(),"Express server listening on port "+g.bold(c),"",{titleColor:l.startsWith("prod")?"green":"yellow"}),console.log("")})),process.env.NODE_ENV=l,process.env.PORT=c}y.post("/api/v1/assets/copy",((e,r)=>{const t=e.query,o=s.normalize(t.to);if(o&&m.hasPermissions(o,r))try{const s=new m(o,e.body,(function(){r.json({success:this.files.size>0,files:Array.from(this.files)}),s.formatMessage(h.logType.NODE,"WRITE",[o,this.files.size+" files"],"")}));S(s,t),s.processAssets("1"===t.empty)}catch(e){r.json({success:!1,error:{hint:"FILE: Unknown",message:e.toString()}})}})),y.post("/api/v1/assets/archive",((e,t)=>{const o=e.query,i=o.to&&s.normalize(o.to),n=s.join(__dirname,"tmp"+s.sep+l.v4());let p;try{r.mkdirpSync(n),i&&m.hasPermissions(i,t)?p=i:(p=n+"-zip",r.mkdirpSync(p))}catch(e){return void t.json({success:!1,error:{hint:`DIRECTORY: ${n}`,message:e.toString()}})}let u=o.append_to,g="",y=!1,b=!1,w=(o.format||"zip").toLowerCase();switch(s.isAbsolute(u)&&(u=s.normalize(u)),w){case"7z":y=!0;break;case"gz":case"tgz":b=!0;case"tar":break;default:w="zip"}const v=()=>{g=s.join(p,(o.filename||g||l.v4())+"."+w);const i=new m(n,e.body,(()=>{const e={success:i.files.size>0,zipname:g,files:Array.from(i.files)},o=r=>{r&&(e.bytes=r),t.json(e),i.formatMessage(h.logType.NODE,"WRITE",[s.basename(g),r+" bytes"])};if(y)d.add(g,n+s.sep+"*",{$bin:f,recursive:!0}).on("end",(()=>o(m.getFileSize(g)))).on("error",(e=>h.writeFail(["Unable to create archive",w],e)));else{const s=c(w,{zlib:{level:m.moduleCompress().gzipLevel}}),a=r.createWriteStream(g);a.on("close",(()=>{if(b){const s="tgz"===w?g.replace(/tar$/,"tgz"):g+".gz";m.moduleCompress().createWriteStreamAsGzip(g,s).on("finish",(()=>{g=s,e.zipname=s,o(m.getFileSize(s))})).on("error",(r=>{e.success=!1,i.writeFail(["Unable to compress file",s],r),t.json(e)}))}else o(s.pointer())})).on("error",(e=>h.writeFail(["Unable to create archive",w],e))),s.pipe(a),s.directory(n,!1),s.finalize()}}));S(i,o);try{i.processAssets()}catch(e){t.json({success:!1,error:{hint:"FILE: Unknown",message:e.toString()}})}};if(u){const e=/([^/\\]+)\.\w+?$/i.exec(u);if(e){const o=s.join(p,e[0]),i=()=>{g=e[1],d.extractFull(o,n,{$bin:f,recursive:!0}).on("end",v).on("error",(e=>{h.writeFail(["Unable to decompress file",o],e),v()}))};try{if(h.isFileURI(u)){const e=r.createWriteStream(o);return e.on("finish",i),void a(u).on("response",(e=>{const s=e.statusCode;s>=300&&h.writeFail(["Unable to download file",u],s+" "+e.statusMessage)})).on("error",(()=>v())).pipe(e)}if(r.existsSync(u)){if(h.isFileUNC(u)){if(!h.hasUNCRead())return void t.json({success:!1,error:{hint:"OPTION: --unc-read",message:"Reading from UNC shares is not enabled."}})}else if(!h.hasDiskRead()&&s.isAbsolute(u))return void t.json({success:!1,error:{hint:"OPTION: --disk-read",message:"Reading from disk is not enabled."}});return void r.copyFile(u,o,i)}h.writeFail("Archive not found",u)}catch(e){h.writeFail(o,e)}}else h.writeFail("Invalid archive format",u)}v()})),y.get("/api/v1/browser/download",((e,s)=>{const r=e.query.uri;r&&s.sendFile(r,(e=>{e&&h.writeFail(["Unable to send file",r],e)}))})),y.get("/api/v1/loader/json",((e,t)=>{const o=e.query.uri;let i=!0;if(o){const e=(e,r)=>{let i;if(!e)try{switch(s.extname(o).toLowerCase()){case".json":case".js":i=JSON.parse(r);break;case".yaml":case".yml":i=u.load(r)}}catch(s){e=s}"object"==typeof i?t.json({success:!0,data:i}):t.json({success:!1,error:{hint:`FILE: Unable to download (${o})`,message:e}})};h.isFileURI(o)?a(o,((s,r)=>e(s,r.body))):r.existsSync(o)&&(h.isFileUNC(o)?h.hasUNCRead()||(i=!1):h.hasDiskRead()||(i=!1),i&&r.readFile(o,"utf8",((s,r)=>e(s,r))))}i||t.json({success:!1,error:{hint:"FILE: Unknown",message:o}})}))}();
