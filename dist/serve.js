!function(){"use strict";var e;Object.defineProperty(exports,"__esModule",{value:!0});const s=require("path"),t=require("fs-extra"),o=require("yargs"),r=require("express"),i=require("cors"),n=require("body-parser"),a=require("request"),l=require("uuid"),c=require("archiver"),d=require("7zip-min"),p=require("js-yaml"),u=require("chalk"),g=require("@squared-functions/file-manager"),m=r();m.use(n.urlencoded({extended:!0}));const y=g.moduleNode();let f,h,b,w,v;function k(e,s){const{chrome:t,watch:o,release:r}=s;f&&e.install("image",f),b&&e.install("gulp",b),w&&e.install("cloud",w),"1"===t&&(h&&e.install("chrome",h,"1"===r),v&&e.install("compress",v)),"1"===o&&e.install("watch",undefined)}{const a=o.usage("$0 [args]").option("access-all",{type:"boolean",description:"Grant full disk and UNC privileges"}).option("access-disk",{alias:"d",type:"boolean",description:"Grant full disk privileges"}).option("access-unc",{alias:"u",type:"boolean",description:"Grant full UNC privileges"}).option("disk-read",{alias:"r",type:"boolean",description:"Grant disk +r (read only)"}).option("disk-write",{alias:"w",type:"boolean",description:"Grant disk +w (write only)"}).option("unc-read",{alias:"y",type:"boolean",description:"Grant UNC +r (read only)"}).option("unc-write",{alias:"z",type:"boolean",description:"Grant UNC +w (write only)"}).option("env",{alias:"e",type:"string",description:"Set environment <prod|dev>",nargs:1}).option("port",{alias:"p",type:"number",description:"Set HTTP port number",nargs:1}).option("cors",{alias:"c",type:"string",description:'Enable CORS access to <origin|"*">',nargs:1}).epilogue("For more information and source: https://github.com/anpham6/squared").argv;let{NODE_ENV:l,PORT:c}=process.env,d=!1;a.accessAll?(y.setDiskRead(),y.setDiskWrite(),y.setUNCRead(),y.setUNCWrite(),d=!0):(a.accessDisk?(y.setDiskRead(),y.setDiskWrite(),d=!0):(a.diskRead&&(y.setDiskRead(),d=!0),a.diskWrite&&(y.setDiskWrite(),d=!0)),a.accessUnc?(y.setUNCRead(),y.setUNCWrite(),d=!0):(a.uncRead&&(y.setUNCRead(),d=!0),a.uncWrite&&(y.setUNCWrite(),d=!0)));let k={};try{k=t.existsSync("./squared.settings.yml")&&p.safeLoad(t.readFileSync(s.resolve("./squared.settings.yml"),"utf8"))||require("./squared.settings.json"),({compress:v,cloud:w,gulp:b,chrome:h}=k),g.loadSettings(k,d),f=require((null===(e=k.image)||void 0===e?void 0:e.command)||"@squared-functions/image/jimp")}catch(e){f=require("@squared-functions/image/jimp"),y.writeFail("Unable to load settings",e)}if(k.routing){a.env&&k.routing[a.env.trim()]?l=a.env.trim():l&&!k.routing[l]&&(l=k.env),l&&k.routing[l]||(l="development");const e=["all","get","post","put","delete","patch","options","head","checkout","connect","copy","lock","merge","mkactivity","mkcol","move","m-search","notify","propfind","proppatch","purge","report","search","subscribe","trace","unlock","unsubscribe"];let t=0,o=0;for(const i of[k.routing.__SHARED__,k.routing[l]])if(Array.isArray(i))for(const n of i){const{path:i,mount:a}=n;if(i&&a){const e=s.join(__dirname,a);try{m.use(i,r.static(e)),y.formatMessage(y.logType.SYSTEM,"MOUNT",`${u.bgGrey(e)} ${u.yellow("->")} ${u.bold(i)}`,"",{titleColor:"yellow"}),++t}catch(e){y.writeFail(["Unable to mount directory",i],e)}}else{let s=n.handler;if(s){"string"==typeof s&&(s=[s]);let t=[];for(const e of s){const s=y.parseFunction(e);s&&t.push(s)}switch(t.length){case 0:continue;case 1:t=t[0]}let r=!1;for(const s of e){const e=n[s];if(e&&"string"==typeof e){try{m[s](e,t),y.formatMessage(y.logType.SYSTEM,"ROUTE",u.bgGrey(e),"",{titleColor:"yellow"}),++o}catch(s){y.writeFail(["Unable to create route",e],s)}r=!0;break}}r||m.use(t)}}}t&&console.log(`\n${u.bold(t)} ${1===t?"directory was":"directories were"} mounted.${o?"":"\n"}`),o&&console.log(`\n${u.bold(o)} ${1===o?"route was":"routes were"} created.\n`)}else l||(l="development"),m.use("/",r.static(s.join(__dirname,"html"))),m.use("/dist",r.static(s.join(__dirname,"dist"))),y.writeFail("Routing not defined");y.formatMessage(y.logType.SYSTEM,"DISK",(y.hasDiskRead()?u.green("+"):u.red("-"))+"r "+(y.hasDiskWrite()?u.green("+"):u.red("-"))+"w","",{titleColor:"blue"}),y.formatMessage(y.logType.SYSTEM,"UNC",(y.hasUNCRead()?u.green("+"):u.red("-"))+"r "+(y.hasUNCWrite()?u.green("+"):u.red("-"))+"w","",{titleColor:"blue"}),a.cors?(m.use(i({origin:a.cors})),m.options("*",i())):k.cors&&k.cors.origin&&(m.use(i(k.cors)),m.options("*",i()),a.cors="string"==typeof k.cors.origin?k.cors.origin:"true"),y.formatMessage(y.logType.SYSTEM,"CORS",a.cors?u.green(a.cors):u.grey("disabled"),"",{titleColor:"blue"}),a.port?c=a.port.toString():!c&&k.port&&(c=k.port[l]),c=+c>=0&&c||"3000",m.use(n.json({limit:k.request_post_limit||"250mb"})),m.listen(c,(()=>{console.log(""),y.formatMessage(y.logType.SYSTEM,l.toUpperCase(),"Express server listening on port "+u.bold(c),"",{titleColor:l.startsWith("prod")?"green":"yellow"}),console.log("")})),process.env.NODE_ENV=l,process.env.PORT=c}m.post("/api/v1/assets/copy",((e,t)=>{const o=e.query,r=s.normalize(o.to);if(r&&g.hasPermissions(r,t))try{const s=new g(r,e.body,(function(){t.json({success:this.files.size>0,files:Array.from(this.files)}),s.formatMessage(y.logType.NODE,"WRITE",[r,this.files.size+" files"],"")}));k(s,o),s.processAssets("1"===o.empty)}catch(e){t.json({success:!1,error:{hint:"FILE: Unknown",message:e.toString()}})}})),m.post("/api/v1/assets/archive",((e,o)=>{const r=e.query,i=r.to&&s.normalize(r.to),n=s.join(__dirname,"tmp"+s.sep+l.v4());let p;try{t.mkdirpSync(n),i&&g.hasPermissions(i,o)?p=i:(p=n+"-zip",t.mkdirpSync(p))}catch(e){return void o.json({success:!1,error:{hint:`DIRECTORY: ${n}`,message:e.toString()}})}let u,m,f=r.append_to,h="";switch(s.isAbsolute(f)&&(f=s.normalize(f)),r.format){case"gz":case"tgz":m=!0;case"tar":u="tar";break;default:u="zip"}const b=i=>{const a=c(u,{zlib:{level:g.moduleCompress().gzipLevel}}),d=new g(n,e.body,(()=>{a.directory(n,!1),a.finalize()}));k(d,r),h=s.join(p,(r.filename||h||l.v4())+"."+u);const f=t.createWriteStream(h);f.on("close",(()=>{const e=d.files.size>0,t={success:e,zipname:h,files:Array.from(d.files),bytes:a.pointer()};if(m&&e){const e="tgz"===r.format?h.replace(/tar$/,"tgz"):h+".gz";g.moduleCompress().createWriteStreamAsGzip(h,e).on("finish",(()=>{t.zipname=e,t.bytes=g.getFileSize(e),d.formatMessage(y.logType.NODE,"WRITE",[s.basename(e),t.bytes+" bytes"],""),o.json(t)})).on("error",(s=>{t.success=!1,d.writeFail(["Unable to compress file",e],s),o.json(t)}))}else o.json(t),d.formatMessage(y.logType.NODE,"WRITE",[s.basename(h),t.bytes+" bytes"],"")})),a.pipe(f);try{i&&a.directory(i,!1),d.processAssets()}catch(e){o.json({success:!1,error:{hint:"FILE: Unknown",message:e.toString()}})}};if(f){const e=/([^/\\]+)\.\w+?$/i.exec(f);if(e){const r=s.join(p,e[0]),i=()=>{h=e[1];const t=s.join(p,h);d.unpack(r,t,(e=>{e?(y.writeFail(["Unable to decompress file",r],e),b()):b(t)}))};try{if(y.isFileURI(f)){const e=t.createWriteStream(r);return e.on("finish",i),void a(f).on("response",(e=>{const s=e.statusCode;s>=300&&y.writeFail(["Unable to download file",f],s+" "+e.statusMessage)})).on("error",(()=>b())).pipe(e)}if(t.existsSync(f)){if(y.isFileUNC(f)){if(!y.hasUNCRead())return void o.json({success:!1,error:{hint:"OPTION: --unc-read",message:"Reading from UNC shares is not enabled."}})}else if(!y.hasDiskRead()&&s.isAbsolute(f))return void o.json({success:!1,error:{hint:"OPTION: --disk-read",message:"Reading from disk is not enabled."}});return void t.copyFile(f,r,i)}y.writeFail("Archive not found",f)}catch(e){y.writeFail(r,e)}}else y.writeFail("Invalid archive format",f)}b()})),m.get("/api/v1/browser/download",((e,s)=>{const t=e.query.uri;t&&s.sendFile(t,(e=>{e&&y.writeFail(["Unable to send file",t],e)}))})),m.get("/api/v1/loader/json",((e,o)=>{const r=e.query.uri;let i=!0;if(r){const e=(e,t)=>{let i;if(!e)try{switch(s.extname(r).toLowerCase()){case".json":case".js":i=JSON.parse(t);break;case".yaml":case".yml":i=p.load(t)}}catch(s){e=s}"object"==typeof i?o.json({success:!0,data:i}):o.json({success:!1,error:{hint:`FILE: Unable to download (${r})`,message:e}})};y.isFileURI(r)?a(r,((s,t)=>e(s,t.body))):t.existsSync(r)&&(y.isFileUNC(r)?y.hasUNCRead()||(i=!1):y.hasDiskRead()||(i=!1),i&&t.readFile(r,"utf8",((s,t)=>e(s,t))))}i||o.json({success:!1,error:{hint:"FILE: Unknown",message:r}})}))}();
