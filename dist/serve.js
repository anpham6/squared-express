!function(){"use strict";var e;Object.defineProperty(exports,"__esModule",{value:!0});const s=require("path"),o=require("fs-extra"),t=require("yargs"),r=require("express"),i=require("cors"),n=require("body-parser"),a=require("request"),l=require("uuid"),c=require("archiver"),d=require("node-7z"),p=require("js-yaml"),u=require("chalk"),g=require("@squared-functions/file-manager"),y=require("@squared-functions/document/chrome"),f={},m={},h=r();h.use(n.urlencoded({extended:!0}));const b=g.moduleNode();let v,w,k,C,R,U;function S(e,s){const{chrome:o,watch:t,release:r}=s;v&&e.install("image",v),C&&e.install("cloud",C),k&&e.install("gulp",k),"1"===o&&(w&&e.install("document",y,w,"1"===r),R&&e.install("compress")),"1"===t&&e.install("watch",undefined)}function q(e,s="",o){switch(e){case"7z":b.formatMessage(b.logType.NODE,"ARCHIVE",["Install required? [npm i 7zip-bin]","7z"],"Binary not found",{titleColor:"yellow"});break;case"archive":b.writeFail(["Unable to create archive",s],o);break;case"download":b.writeFail(["Unable to download file",s],o)}}{const a=t.usage("$0 [args]").option("access-all",{type:"boolean",description:"Grant full disk and UNC privileges"}).option("access-disk",{alias:"d",type:"boolean",description:"Grant full disk privileges"}).option("access-unc",{alias:"u",type:"boolean",description:"Grant full UNC privileges"}).option("disk-read",{alias:"r",type:"boolean",description:"Grant disk +r (read only)"}).option("disk-write",{alias:"w",type:"boolean",description:"Grant disk +w (write only)"}).option("unc-read",{alias:"y",type:"boolean",description:"Grant UNC +r (read only)"}).option("unc-write",{alias:"z",type:"boolean",description:"Grant UNC +w (write only)"}).option("env",{alias:"e",type:"string",description:"Set environment <prod|dev>",nargs:1}).option("port",{alias:"p",type:"number",description:"Set HTTP port number",nargs:1}).option("cors",{alias:"c",type:"string",description:'Enable CORS access to <origin|"*">',nargs:1}).epilogue("For more information and source: https://github.com/anpham6/squared").argv;let{NODE_ENV:l,PORT:c}=process.env,d=!1;a.accessAll?(b.setDiskRead(),b.setDiskWrite(),b.setUNCRead(),b.setUNCWrite(),d=!0):(a.accessDisk?(b.setDiskRead(),b.setDiskWrite(),d=!0):(a.diskRead&&(b.setDiskRead(),d=!0),a.diskWrite&&(b.setDiskWrite(),d=!0)),a.accessUnc?(b.setUNCRead(),b.setUNCWrite(),d=!0):(a.uncRead&&(b.setUNCRead(),d=!0),a.uncWrite&&(b.setUNCWrite(),d=!0)));let y={};try{if(y=o.existsSync("./squared.settings.yml")&&p.load(o.readFileSync(s.resolve("./squared.settings.yml"),"utf8"))||require("./squared.settings.json"),({compress:R,cloud:C,gulp:k,chrome:w}=y),g.loadSettings(y,d),R){const e=R["7za_bin"];if(e&&o.existsSync(e))U=e;else try{const e=require("7zip-bin");U=e.path7za}catch(e){}}v=require((null===(e=y.image)||void 0===e?void 0:e.command)||"@squared-functions/image/jimp")}catch(e){v=require("@squared-functions/image/jimp"),b.writeFail("Unable to load settings",e)}if(y.routing){a.env&&y.routing[a.env.trim()]?l=a.env.trim():l&&!y.routing[l]&&(l=y.env),l&&y.routing[l]||(l="development");const e=["all","get","post","put","delete","patch","options","head","checkout","connect","copy","lock","merge","mkactivity","mkcol","move","m-search","notify","propfind","proppatch","purge","report","search","subscribe","trace","unlock","unsubscribe"];let o=0,t=0;for(const i of[y.routing.__SHARED__,y.routing[l]])if(Array.isArray(i))for(const n of i){const{path:i,mount:a}=n;if(i&&a){const e=s.join(__dirname,a);try{h.use(i,r.static(e)),b.formatMessage(b.logType.SYSTEM,"MOUNT",`${u.bgGrey(e)} ${u.yellow("->")} ${u.bold(i)}`,"",{titleColor:"yellow"}),++o}catch(e){b.writeFail(["Unable to mount directory",i],e)}}else{let s=n.handler;if(s){"string"==typeof s&&(s=[s]);let o=[];for(const e of s){const s=b.parseFunction(e);s&&o.push(s)}switch(o.length){case 0:continue;case 1:o=o[0]}let r=!1;for(const s of e){const e=n[s];if(e&&"string"==typeof e){try{h[s](e,o),b.formatMessage(b.logType.SYSTEM,"ROUTE",u.bgGrey(e),"",{titleColor:"yellow"}),++t}catch(s){b.writeFail(["Unable to create route",e],s)}r=!0;break}}r||h.use(o)}}}o&&console.log(`\n${u.bold(o)} ${1===o?"directory was":"directories were"} mounted.${t?"":"\n"}`),t&&console.log(`\n${u.bold(t)} ${1===t?"route was":"routes were"} created.\n`)}else l||(l="development"),h.use("/",r.static(s.join(__dirname,"html"))),h.use("/dist",r.static(s.join(__dirname,"dist"))),b.writeFail("Routing not defined");b.formatMessage(b.logType.SYSTEM,"DISK",(b.hasDiskRead()?u.green("+"):u.red("-"))+"r "+(b.hasDiskWrite()?u.green("+"):u.red("-"))+"w","",{titleColor:"blue"}),b.formatMessage(b.logType.SYSTEM,"UNC",(b.hasUNCRead()?u.green("+"):u.red("-"))+"r "+(b.hasUNCWrite()?u.green("+"):u.red("-"))+"w","",{titleColor:"blue"}),a.cors?(h.use(i({origin:a.cors})),h.options("*",i())):y.cors&&y.cors.origin&&(h.use(i(y.cors)),h.options("*",i()),a.cors="string"==typeof y.cors.origin?y.cors.origin:"true"),b.formatMessage(b.logType.SYSTEM,"CORS",a.cors?u.green(a.cors):u.grey("disabled"),"",{titleColor:"blue"}),a.port?c=a.port.toString():!c&&y.port&&(c=y.port[l]),c=+c>=0&&c||"3000",h.use(n.json({limit:y.request_post_limit||"250mb"})),h.listen(c,(()=>{console.log(""),b.formatMessage(b.logType.SYSTEM,l.toUpperCase(),"Express server listening on port "+u.bold(c),"",{titleColor:l.startsWith("prod")?"green":"yellow"}),console.log("")})),process.env.NODE_ENV=l,process.env.PORT=c}h.post("/api/v1/assets/copy",((e,o)=>{const t=e.query,r=s.normalize(t.to);if(r&&g.hasPermissions(r,o))try{const s=new g(r,e.body,(function(){o.json({success:this.files.size>0,files:Array.from(this.files)}),s.formatMessage(b.logType.NODE,"WRITE",[r,this.files.size+" files"],"")}));S(s,t),s.processAssets("1"===t.empty)}catch(e){o.json(b.getResponseError("FILE: Unknown",e.toString()))}})),h.post("/api/v1/assets/archive",((e,t)=>{const r=e.query,i=r.to&&s.normalize(r.to);let n,p=s.join(__dirname,"tmp",l.v4());try{i&&g.hasPermissions(i,t)?p=i:o.mkdirpSync(p),n=p+"-zip",o.mkdirpSync(n)}catch(e){return void t.json(b.getResponseError(`DIRECTORY: ${p}`,e.toString()))}let u=r.append_to,y=!1,f=!1,h=(r.format||"zip").toLowerCase();switch(s.isAbsolute(u)&&(u=s.normalize(u)),h){case"7z":U?y=!0:(q("7z"),h="zip");break;case"gz":case"tgz":f=!0;case"tar":break;default:h="zip"}const v=i=>{i=(r.filename||i||l.v4())+"."+h;let a=s.join(n,i);const u=new g(p,e.body,(()=>{const e={success:u.files.size>0,zipname:i,files:Array.from(u.files)},r=s=>{if(s){const o=l.v4();e.bytes=s,e.downloadKey=o,m[o]=a}else e.success=!1;t.json(e),u.formatMessage(b.logType.NODE,"WRITE",[e.zipname,s+" bytes"])};if(y)d.add(a,p+s.sep+"*",{$bin:U,recursive:!0}).on("end",(()=>r(g.getFileSize(a)))).on("error",(e=>q("archive",h,e)));else{const i=c(h,{zlib:{level:g.moduleCompress().gzipLevel}}),n=o.createWriteStream(a);n.on("close",(()=>{if(f){const o="tgz"===h?a.replace(/tar$/,"tgz"):a+".gz";g.moduleCompress().createWriteStreamAsGzip(a,o).on("finish",(()=>{a=o,e.zipname=s.basename(o),r(g.getFileSize(o))})).on("error",(s=>{e.success=!1,q("archive",h,s),t.json(e)}))}else r(i.pointer())})).on("error",(e=>q("archive",h,e))),i.pipe(n),i.directory(p,!1),i.finalize()}}));S(u,r);try{u.processAssets()}catch(e){t.json(b.getResponseError("FILE: Unknown",e.toString()))}};if(u)if(U){const e=/([^/\\]+)\.\w+?$/i.exec(u);if(e){const r=s.join(n,e[0]),i=()=>{d.extractFull(r,p,{$bin:U,recursive:!0}).on("end",(()=>{v(e[1])})).on("error",(e=>{b.writeFail(["Unable to decompress file",r],e),v()}))};try{if(b.isFileURI(u)){const e=o.createWriteStream(r);let s;return e.on("finish",i),void a(u).on("response",(e=>{const o=e.statusCode;o>=300&&(q("download",u,o+" "+e.statusMessage),s=!0)})).on("error",(e=>{s||q("download",u,e),v()})).pipe(e)}if(o.existsSync(u)){if(b.isFileUNC(u)){if(!b.hasUNCRead())return void t.json(b.getResponseError("OPTION: --unc-read","Reading from UNC shares is not enabled."))}else if(!b.hasDiskRead()&&s.isAbsolute(u))return void t.json(b.getResponseError("OPTION: --disk-read","Reading from disk is not enabled."));return void o.copyFile(u,r,i)}b.writeFail("Archive not found",u)}catch(e){b.writeFail(r,e)}}else b.writeFail("Invalid archive format",u)}else q("7z");v()})),h.get("/api/v1/loader/data/json",((e,t)=>{const r=e.query.key,i="1"===e.query.cache;if(r){let e=!0;const n=(e,o)=>{let n;if(!e)try{switch(s.extname(r).toLowerCase()){case".json":case".js":n=JSON.parse(o);break;case".yml":case".yaml":n=p.load(o)}}catch(s){e=s}"object"==typeof n?(i&&(f[r]=n),t.json({success:!0,data:n})):t.json(b.getResponseError(`FILE: Unable to download (${r})`,e))};if(i&&f[r]||b.isUUID(r)){const e=f[r];e?t.json({success:!0,data:e}):t.json(b.getResponseError("CACHE: Could not locate key",r))}else b.isFileURI(r)?a(r,((e,s)=>n(e,s.body))):o.existsSync(r)?(e=b.isFileUNC(r)?b.hasUNCRead():b.hasDiskRead(),e&&o.readFile(r,"utf8",((e,s)=>n(e,s)))):e=!1;e||t.json(b.getResponseError("FILE: Unknown",r))}})),h.get("/api/v1/loader/data/blob",((e,s)=>{const o=e.query.key,t=m[o];t&&("0"===e.query.cache&&delete m[o],s.sendFile(t,(e=>{e&&b.writeFail(["Unable to send file",t],e)})))}))}();
